<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magazinify AI™ — Flipbook Viewer</title>
  <link rel="icon" href="/favicon.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
</head>
<body class="bg-slate-950 text-white antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-white/10 bg-slate-950/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="/logo.svg" alt="Magazinify AI" class="h-7 w-7" />
        <span class="text-base font-semibold">Magazinify AI™</span>
      </a>
      <div class="flex items-center gap-3">
        <button id="printBtn" class="rounded-lg border border-white/20 px-3 py-2 text-sm hover:bg-white/5">Print</button>
        <a id="download" class="rounded-lg bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-white/90" download>Download PDF</a>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-6 py-8">
    <h1 class="text-2xl font-semibold">Flipbook Viewer</h1>
    <p class="mt-2 text-white/70 text-sm">
      Generating a print-ready PDF on the server. This demo uses <code>/api/generate/sync</code>.
    </p>

    <!-- Progress -->
    <div class="mt-6 h-2 w-full rounded bg-white/10 overflow-hidden" aria-hidden="true">
      <div id="bar" class="h-2 w-0 bg-sky-400 transition-[width]"></div>
    </div>

    <!-- Viewer -->
    <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-3">
      <iframe id="preview" title="PDF Preview" class="h-[70vh] w-full rounded-xl border-0 bg-slate-900"></iframe>
    </div>

    <!-- Status / errors -->
    <p id="status" class="mt-3 text-white/60 text-sm"></p>
  </main>

  <script>
    // Query params: ?website=...
    const qp = new URLSearchParams(location.search);
    const website = qp.get('website') || '';

    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const preview = document.getElementById('preview');
    const download = document.getElementById('download');
    const printBtn = document.getElementById('printBtn');

    function setBar(p) { bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
    function setStatus(msg) { statusEl.textContent = msg || ''; }

    async function generateSync() {
      setBar(8);
      setStatus('Starting generation…');

      const payload = {
        website,
        title: 'Magazinify AI — Print Preview',
        theme: 'modern'
      };

      let res;
      try {
        res = await fetch('/api/generate/sync', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (e) {
        setBar(100);
        setStatus('Network error. Please try again.');
        throw e;
      }

      setBar(55);
      if (!res.ok) {
        setBar(100);
        setStatus('Generation failed: ' + res.status + ' ' + (res.statusText || ''));
        throw new Error('Generation failed');
      }

      const blob = await res.blob();
      setBar(85);

      // Use the returned PDF for both iframe preview and download link
      const url = URL.createObjectURL(blob);
      preview.src = url;
      download.href = url;
      download.setAttribute('download', 'magazinify.pdf');

      setBar(100);
      setStatus('Done');
    }

    // Kick off generation on load
    (async () => {
      try {
        await generateSync();
      } catch (e) {
        console.error(e);
      }
    })();

    // Print the PDF shown in the iframe
    printBtn.addEventListener('click', () => {
      if (preview?.contentWindow) {
        try { preview.contentWindow.focus(); preview.contentWindow.print(); }
        catch { alert('Print preview is not ready yet. Please try again.'); }
      }
    });
  </script>
</body>
</html>
